<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
<title>FEN Master Tracker - Nivelaci√≥n</title>
<style>
    :root {
        --bg: #0d1117; --surface: #161b22; --surface-highlight: #21262d;
        --border: #30363d; --text: #c9d1d9; --text-muted: #8b949e;
        --accent: #58a6ff; --success: #238636; --warning: #d29922; --danger: #f85149;
        
        /* Colores por √Årea */
        --c-math: #7ee787;   /* Verde Matrix */
        --c-micro: #f0883e;  /* Naranja Utility */
        --c-macro: #d2a8ff;  /* Morado Growth */
        --c-metrics: #79c0ff;/* Azul OLS */

        --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        --font-mono: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg); color: var(--text); font-family: var(--font-main); margin: 0; padding-bottom: 80px; }
    
    /* --- HEADER & STICKY STATS --- */
    .sticky-header {
        position: sticky; top: 0; z-index: 100;
        background: rgba(13, 17, 23, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border);
        padding: 12px 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .app-title { font-weight: 700; font-size: 1.1rem; color: #fff; margin: 0; }
    .app-subtitle { font-size: 0.8rem; color: var(--text-muted); }
    
    /* Progress Bar */
    .prog-container { height: 6px; background: var(--surface); border-radius: 3px; overflow: hidden; position: relative; }
    .prog-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); width: 0%; transition: width 0.4s ease; }
    
    /* --- LAYOUT & GRID --- */
    .container { max-width: 1000px; margin: 0 auto; padding: 16px; }
    
    /* Dashboard Cards */
    .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 24px; }
    .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 12px; text-align: center; }
    .stat-val { font-family: var(--font-mono); font-size: 1.5rem; font-weight: 700; color: #fff; }
    .stat-lbl { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

    /* --- WEEK ACCORDION (Mobile Friendly) --- */
    .week-group { margin-bottom: 16px; border: 1px solid var(--border); border-radius: 12px; background: var(--surface); overflow: hidden; transition: border-color 0.2s; }
    .week-group.active { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent); }
    
    .week-header {
        padding: 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        background: var(--surface); border-bottom: 1px solid transparent; user-select: none;
    }
    .week-group[open] .week-header { border-bottom-color: var(--border); background: var(--surface-highlight); }
    .wk-title { font-weight: 700; font-size: 1rem; color: #fff; }
    .wk-dates { font-size: 0.8rem; color: var(--text-muted); font-family: var(--font-mono); }
    .wk-progress { font-size: 0.75rem; font-weight: 600; color: var(--accent); }

    /* --- TOPIC CARDS --- */
    .topic-list { display: grid; grid-template-columns: 1fr; }
    @media (min-width: 768px) { .topic-list { grid-template-columns: 1fr 1fr; } } /* iPad: 2 columnas */
    
    .topic-card { padding: 16px; border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); position: relative; }
    .topic-card:last-child { border-bottom: none; }
    
    /* Badges */
    .badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
    .b-math { background: rgba(126, 231, 135, 0.15); color: var(--c-math); border: 1px solid rgba(126, 231, 135, 0.3); }
    .b-micro { background: rgba(240, 136, 62, 0.15); color: var(--c-micro); border: 1px solid rgba(240, 136, 62, 0.3); }
    .b-macro { background: rgba(210, 168, 255, 0.15); color: var(--c-macro); border: 1px solid rgba(210, 168, 255, 0.3); }
    .b-metrics { background: rgba(121, 192, 255, 0.15); color: var(--c-metrics); border: 1px solid rgba(121, 192, 255, 0.3); }

    .topic-title { font-size: 0.95rem; font-weight: 600; margin-bottom: 4px; color: #fff; }
    .topic-book { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px; display: block; font-family: var(--font-mono); }
    
    /* Tasks & Links */
    .task-list { list-style: none; padding: 0; margin: 0; }
    .task-item { display: flex; align-items: flex-start; gap: 10px; padding: 6px 0; font-size: 0.9rem; color: var(--text); }
    
    /* Custom Checkbox */
    input[type="checkbox"] {
        appearance: none; -webkit-appearance: none;
        width: 20px; height: 20px; border: 2px solid var(--border); border-radius: 5px; flex-shrink: 0;
        background: #0d1117; cursor: pointer; position: relative; margin-top: 2px;
    }
    input[type="checkbox"]:checked { background: var(--success); border-color: var(--success); }
    input[type="checkbox"]:checked::after {
        content: '‚úî'; position: absolute; color: #fff; font-size: 12px; top: 0px; left: 4px; font-weight: bold;
    }

    /* Video Link Button */
    .video-btn {
        display: inline-flex; align-items: center; gap: 6px; margin-top: 10px;
        background: #21262d; border: 1px solid var(--border); padding: 6px 12px;
        border-radius: 20px; font-size: 0.75rem; color: var(--accent); text-decoration: none;
        transition: all 0.2s;
    }
    .video-btn:hover { background: #30363d; border-color: var(--text-muted); transform: translateY(-1px); }
    .video-icon { fill: currentColor; width: 14px; height: 14px; }

    /* Controls (Bottom Bar on Mobile) */
    .controls-area {
        margin-top: 20px; padding: 16px; background: var(--surface); border-radius: 12px; border: 1px solid var(--border);
        display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;
    }
    .btn { background: var(--surface-highlight); color: var(--text); border: 1px solid var(--border); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
    .btn-danger { color: var(--danger); border-color: rgba(248, 81, 73, 0.4); }
    
    /* Setup Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal { background: var(--surface); border: 1px solid var(--border); padding: 24px; border-radius: 12px; width: 90%; max-width: 400px; }
    input[type="date"] { background: #0d1117; color: #fff; border: 1px solid var(--border); padding: 8px; border-radius: 6px; width: 100%; margin-top: 5px; font-size: 1rem; }

</style>
</head>
<body>

<div class="sticky-header">
    <div class="header-top">
        <div>
            <h1 class="app-title">FEN Master Tracker</h1>
            <span class="app-subtitle" id="currentDateDisplay">Cargando...</span>
        </div>
        <div style="text-align:right">
            <div style="font-weight:700; color:#fff;" id="headerPercent">0%</div>
        </div>
    </div>
    <div class="prog-container">
        <div class="prog-fill" id="headerFill"></div>
    </div>
</div>

<div class="container">

    <div class="dashboard">
        <div class="stat-card">
            <div class="stat-val" id="kpiDone">0</div>
            <div class="stat-lbl">Checks Listos</div>
        </div>
        <div class="stat-card">
            <div class="stat-val" id="kpiLeft">0</div>
            <div class="stat-lbl">Pendientes</div>
        </div>
        <div class="stat-card" style="cursor:pointer;" onclick="openSetup()">
            <div class="stat-val">‚öôÔ∏è</div>
            <div class="stat-lbl">Ajustar Fecha</div>
        </div>
    </div>

    <div id="plannerArea"></div>

    <div class="controls-area">
        <button class="btn" onclick="exportData()">üíæ Guardar Respaldo</button>
        <button class="btn" onclick="importData()">üìÇ Cargar Respaldo</button>
        <button class="btn btn-danger" onclick="resetData()">Resetear Todo</button>
    </div>
    <div style="text-align:center; margin-top:20px; color:#484f58; font-size:0.8rem;">
        Optimizado para iPad/iPhone ¬∑ Mag√≠ster Econom√≠a
    </div>
</div>

<div class="modal-overlay" id="setupModal">
    <div class="modal">
        <h3 style="margin-top:0; color:#fff;">Configuraci√≥n</h3>
        <p style="color:var(--text-muted); font-size:0.9rem;">Elige la fecha de inicio de tu nivelaci√≥n. Las semanas se ajustar√°n autom√°ticamente.</p>
        <label style="font-size:0.8rem; font-weight:bold; color:var(--text-muted);">FECHA INICIO:</label>
        <input type="date" id="startDateInput">
        <button class="btn" style="width:100%; margin-top:20px; background:var(--accent); color:#000; border:none; font-weight:bold;" onclick="saveSetup()">Guardar y Empezar</button>
    </div>
</div>

<script>
/* ======================== 1. DATOS MAESTROS (CURADOS) ======================== */
const PLAN = [
    {
        w: 1, title: "Fundamentos & √Ålgebra Matricial",
        topics: [
            { area: "math", title: "√Ålgebra Matricial para Econometr√≠a", book: "Simon & Blume Ch. 6-9", 
              tasks: ["Vectores y Espacios (Independencia Lineal)", "Sistemas Ax=b y Rango", "Determinantes e Inversas"],
              video: { label: "MIT: Matrix Algebra", url: "https://www.youtube.com/watch?v=ZK3O402wf1c&list=PL49CF3715CB9EF31D" } 
            },
            { area: "micro", title: "Teor√≠a del Consumidor", book: "Nicholson & Snyder Ch. 3-4", 
              tasks: ["Axiomas de preferencias", "Restricci√≥n Presupuestaria", "Maximizaci√≥n de Utilidad (Lagrangiano Intro)"],
              video: { label: "Micro: Consumer Theory", url: "https://www.youtube.com/watch?v=1Y2r36wS01c" } 
            },
            { area: "metrics", title: "Repaso Estad√≠stico", book: "Wooldridge Ap√©ndice B", 
              tasks: ["Esperanza y Varianza (Propiedades)", "Covarianza y Correlaci√≥n", "Distribuci√≥n Normal Standard"],
              video: { label: "Probabilidad B√°sica", url: "https://www.youtube.com/watch?v=Kz_yWZkMaEk" } 
            },
            { area: "macro", title: "Datos e Identidades", book: "De Gregorio Cap. 2", 
              tasks: ["PIB, Inflaci√≥n y Desempleo", "Identidades Contables", "Balanza de Pagos"],
              video: { label: "Macro Data (MRU)", url: "https://www.youtube.com/watch?v=d8uTB5qBntE" } 
            }
        ]
    },
    {
        w: 2, title: "C√°lculo Multivariable & OLS Simple",
        topics: [
            { area: "math", title: "C√°lculo Diferencial", book: "Simon & Blume Ch. 14-15", 
              tasks: ["Derivadas Parciales", "Gradiente y Hessiano", "Convexidad y Concavidad"],
              video: { label: "Khan: Multivariable", url: "https://www.youtube.com/watch?v=TrcCjyW7xVI" } 
            },
            { area: "metrics", title: "Modelo Lineal Simple (OLS)", book: "Wooldridge Cap. 2", 
              tasks: ["Derivar estimadores B0 y B1", "R-cuadrado", "Supuestos Gauss-Markov (Intro)"],
              video: { label: "Ben Lambert: OLS Derivation", url: "https://www.youtube.com/watch?v=b4YlQ912kIs" } 
            },
            { area: "micro", title: "Demanda y Slutsky", book: "Nicholson Cap. 5-6", 
              tasks: ["Demanda Marshaliana vs Hicksiana", "Ecuaci√≥n de Slutsky (Efecto Ingreso/Sustituci√≥n)"],
              video: { label: "Slutsky Equation", url: "https://www.youtube.com/watch?v=ZUpYvD1O7cI" } 
            },
            { area: "macro", title: "Modelo de Solow", book: "De Gregorio Cap. 12", 
              tasks: ["Acumulaci√≥n de Capital", "Estado Estacionario", "Regla de Oro"],
              video: { label: "Marginal Rev: Solow", url: "https://www.youtube.com/watch?v=3nK29971D50" } 
            }
        ]
    },
    {
        w: 3, title: "Optimizaci√≥n & Regresi√≥n M√∫ltiple",
        topics: [
            { area: "math", title: "Optimizaci√≥n con Restricciones", book: "Simon & Blume Ch. 18", 
              tasks: ["Multiplicadores de Lagrange", "Interpretaci√≥n Econ√≥mica de Lambda", "Condiciones de 2do Orden"],
              video: { label: "Lagrange Multipliers", url: "https://www.youtube.com/watch?v=hQ4UNu1P2kw" } 
            },
            { area: "metrics", title: "Regresi√≥n M√∫ltiple: Estimaci√≥n", book: "Wooldridge Cap. 3", 
              tasks: ["Interpretaci√≥n Ceteris Paribus", "Sesgo por Variable Omitida", "Multicolinealidad"],
              video: { label: "Omitted Variable Bias", url: "https://www.youtube.com/watch?v=6J_q9C-Vqos" } 
            },
            { area: "micro", title: "Teor√≠a de la Firma", book: "Nicholson Cap. 9-10", 
              tasks: ["Minimizaci√≥n de Costos", "Funciones de Costo (Cmg, Cme)", "Oferta de la firma"],
              video: { label: "Cost Functions", url: "https://www.youtube.com/watch?v=ucJBO9gkUoQ" } 
            },
            { area: "macro", title: "Consumo Intertemporal", book: "De Gregorio Cap. 4", 
              tasks: ["Modelo de 2 periodos", "Restricci√≥n presupuestaria intertemporal", "Ecuaci√≥n de Euler"],
              video: { label: "Consumption Smoothing", url: "https://www.youtube.com/watch?v=Nu49gqg2q3k" } 
            }
        ]
    },
    {
        w: 4, title: "Equilibrio General & Inferencia",
        topics: [
            { area: "micro", title: "Equilibrio General e Intercambio", book: "Nicholson Cap. 13", 
              tasks: ["Caja de Edgeworth", "Eficiencia de Pareto", "Teoremas del Bienestar"],
              video: { label: "BurkeyAcademy: Edgeworth", url: "https://www.youtube.com/watch?v=QfiYJFxY360" } 
            },
            { area: "metrics", title: "Inferencia Estad√≠stica", book: "Wooldridge Cap. 4", 
              tasks: ["Tests de Hip√≥tesis (t-test)", "Intervalos de Confianza", "Significancia Econ√≥mica vs Estad√≠stica"],
              video: { label: "Hypothesis Testing", url: "https://www.youtube.com/watch?v=Jjq9a3y8wUk" } 
            },
            { area: "math", title: "Kuhn-Tucker (Desigualdades)", book: "Simon & Blume Ch. 19", 
              tasks: ["Condiciones de Holgura", "Teorema de la Envolvente"],
              video: { label: "Kuhn Tucker Intuition", url: "https://www.youtube.com/watch?v=J3yN-eWc-4M" } 
            },
             { area: "macro", title: "Modelo IS-LM", book: "De Gregorio Cap. 14", 
              tasks: ["Mercado de Bienes (IS)", "Mercado Monetario (LM)", "Pol√≠tica Fiscal y Monetaria"],
              video: { label: "IS-LM Model", url: "https://www.youtube.com/watch?v=7yK7q1H6i5E" } 
            }
        ]
    },
    {
        w: 5, title: "Fallas de Mercado & Asint√≥tica",
        topics: [
            { area: "micro", title: "Monopolio y Discriminaci√≥n", book: "Nicholson Cap. 14", 
              tasks: ["Maximizaci√≥n del Monopolista", "Discriminaci√≥n de 1er, 2do y 3er grado", "P√©rdida de Eficiencia"],
              video: { label: "Price Discrimination", url: "https://www.youtube.com/watch?v=Rj3qf_c18Yg" } 
            },
            { area: "metrics", title: "Asint√≥tica (Muestras Grandes)", book: "Wooldridge Cap. 5", 
              tasks: ["Consistencia vs Insesgadez", "Convergencia en Probabilidad", "Ley de Grandes N√∫meros"],
              video: { label: "Consistency vs Unbiasedness", url: "https://www.youtube.com/watch?v=3RzG6n4MWvw" } 
            },
            { area: "macro", title: "Oferta y Demanda Agregada", book: "De Gregorio Cap. 17", 
              tasks: ["Curva de Phillips", "Expectativas Racionales", "Shock de Oferta"],
              video: { label: "AS-AD Model", url: "https://www.youtube.com/watch?v=5lZqX2_XQ34" } 
            },
            { area: "math", title: "Ecuaciones Diferenciales", book: "Simon & Blume Ch. 24", 
              tasks: ["EDO de primer orden", "Diagramas de Fase", "Estabilidad del equilibrio"],
              video: { label: "Phase Diagrams", url: "https://www.youtube.com/watch?v=P676451eF5M" } 
            }
        ]
    },
    {
        w: 6, title: "Externalidades & Heterocedasticidad",
        topics: [
            { area: "micro", title: "Externalidades y Bienes P√∫blicos", book: "Nicholson Cap. 19", 
              tasks: ["Impuestos Pigouvianos", "Teorema de Coase", "Condici√≥n de Samuelson"],
              video: { label: "Public Goods", url: "https://www.youtube.com/watch?v=1_3A_r8a-1I" } 
            },
            { area: "metrics", title: "Heterocedasticidad", book: "Wooldridge Cap. 8", 
              tasks: ["Detecci√≥n (Breusch-Pagan/White)", "Errores Est√°ndar Robustos", "GLS (M√≠nimos Cuadrados Generalizados)"],
              video: { label: "Heteroskedasticity", url: "https://www.youtube.com/watch?v=3M232y_D948" } 
            },
            { area: "macro", title: "Pol√≠tica Monetaria (Taylor)", book: "De Gregorio Cap. 19", 
              tasks: ["Reglas de Taylor", "Inconsistencia Din√°mica", "Banco Central Independiente"],
              video: { label: "Taylor Rule", url: "https://www.youtube.com/watch?v=y3qT1_y8y5w" } 
            }
        ]
    },
    {
        w: 7, title: "Teor√≠a de Juegos & Series de Tiempo",
        topics: [
            { area: "micro", title: "Teor√≠a de Juegos Est√°ticos", book: "Nicholson Cap. 8", 
              tasks: ["Equilibrio de Nash", "Estrategias Dominantes", "Dilema del Prisionero"],
              video: { label: "Game Theory 101", url: "https://www.youtube.com/watch?v=M8C2d5VvKFE" } 
            },
            { area: "metrics", title: "Series de Tiempo Intro", book: "Wooldridge Cap. 10", 
              tasks: ["Modelos Est√°ticos vs Din√°micos", "Tendencia y Estacionalidad", "Supuestos TS"],
              video: { label: "Time Series Intro", url: "https://www.youtube.com/watch?v=Y2k6N5yL-n0" } 
            },
            { area: "macro", title: "Crecimiento End√≥geno (Intro)", book: "Romer / De Gregorio", 
              tasks: ["Modelos AK", "Capital Humano", "Innovaci√≥n y R&D"],
              video: { label: "Endogenous Growth", url: "https://www.youtube.com/watch?v=sc1-Noyk-jM" } 
            }
        ]
    },
    {
        w: 8, title: "Repaso & Simulaci√≥n Ex√°menes",
        topics: [
            { area: "math", title: "Repaso Final Matem√°ticas", book: "Cuadernos", tasks: ["Resolver Examen A√±o Anterior"], video: null },
            { area: "micro", title: "Repaso Final Micro", book: "Cuadernos", tasks: ["Resolver Examen A√±o Anterior"], video: null },
            { area: "metrics", title: "Repaso Final Econometr√≠a", book: "Cuadernos", tasks: ["Resolver Examen A√±o Anterior"], video: null },
            { area: "macro", title: "Repaso Final Macro", book: "Cuadernos", tasks: ["Resolver Examen A√±o Anterior"], video: null }
        ]
    }
];

/* ======================== 2. SISTEMA DE ESTADO ======================== */
const STORAGE_KEY = "fen_master_tracker_v3";
let state = {
    startDate: new Date().toISOString().split('T')[0], // Hoy por defecto
    checks: {} 
};

function init() {
    loadState();
    
    // Si no hay fecha configurada o es la primera vez, abrir modal
    if (!localStorage.getItem(STORAGE_KEY)) {
        document.getElementById("setupModal").style.display = "flex";
        document.getElementById("startDateInput").value = state.startDate;
    } else {
        render();
    }
    
    // Header date
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById("currentDateDisplay").textContent = new Date().toLocaleDateString('es-ES', options);
}

function loadState() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) state = JSON.parse(raw);
}

function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    updateKPIs();
}

function saveSetup() {
    const val = document.getElementById("startDateInput").value;
    if(val) {
        state.startDate = val;
        saveState();
        document.getElementById("setupModal").style.display = "none";
        render();
    }
}

function openSetup() {
    document.getElementById("startDateInput").value = state.startDate;
    document.getElementById("setupModal").style.display = "flex";
}

/* ======================== 3. L√ìGICA DE RENDERIZADO ======================== */

function getDatesForWeek(weekIndex) {
    const start = new Date(state.startDate);
    start.setDate(start.getDate() + ((weekIndex-1) * 7));
    
    const end = new Date(start);
    end.setDate(end.getDate() + 6);
    
    // Formato dd/mm
    const fmt = d => d.getDate().toString().padStart(2,'0') + "/" + (d.getMonth()+1).toString().padStart(2,'0');
    return `${fmt(start)} - ${fmt(end)}`;
}

function isCurrentWeek(weekIndex) {
    const start = new Date(state.startDate);
    start.setDate(start.getDate() + ((weekIndex-1) * 7));
    const end = new Date(start);
    end.setDate(end.getDate() + 6);
    end.setHours(23,59,59);
    
    const now = new Date();
    return now >= start && now <= end;
}

function render() {
    const container = document.getElementById("plannerArea");
    container.innerHTML = "";
    
    PLAN.forEach(week => {
        // C√°lculo de fechas
        const dateRange = getDatesForWeek(week.w);
        const isCurrent = isCurrentWeek(week.w);
        
        // Calcular progreso de la semana
        let wTotal = 0;
        let wDone = 0;
        week.topics.forEach(t => {
            t.tasks.forEach((tsk, i) => {
                wTotal++;
                if(state.checks[`w${week.w}_${t.area}_${i}`]) wDone++;
            });
        });
        const wPct = wTotal ? Math.round((wDone/wTotal)*100) : 0;
        
        // HTML Estructura (Accordion)
        const details = document.createElement("details");
        details.className = `week-group ${isCurrent ? "active" : ""}`;
        if(isCurrent) details.setAttribute("open", ""); // Abrir autom√°ticamente la semana actual

        // HEADER SEMANA
        details.innerHTML = `
            <summary class="week-header">
                <div>
                    <div class="wk-title">Semana ${week.w}: ${week.title}</div>
                    <div class="wk-dates">${dateRange} ${isCurrent ? "‚Ä¢ <span style='color:var(--accent)'>ACTUAL</span>" : ""}</div>
                </div>
                <div class="wk-progress">${wPct}%</div>
            </summary>
            <div class="topic-list" id="content-w${week.w}"></div>
        `;
        
        // TOPICS INTERNOS
        const contentDiv = details.querySelector(`#content-w${week.w}`);
        
        week.topics.forEach(topic => {
            let badgeClass = "";
            if(topic.area === "math") badgeClass = "b-math";
            else if(topic.area === "micro") badgeClass = "b-micro";
            else if(topic.area === "macro") badgeClass = "b-macro";
            else badgeClass = "b-metrics";
            
            const card = document.createElement("div");
            card.className = "topic-card";
            
            // Render Tasks
            let tasksHtml = "";
            topic.tasks.forEach((task, i) => {
                const uid = `w${week.w}_${topic.area}_${i}`;
                const checked = state.checks[uid] ? "checked" : "";
                tasksHtml += `
                    <label class="task-item">
                        <input type="checkbox" id="${uid}" ${checked} onchange="toggleCheck('${uid}')">
                        <span>${task}</span>
                    </label>
                `;
            });
            
            // Render Video Button if exists
            let videoHtml = "";
            if(topic.video) {
                videoHtml = `
                    <a href="${topic.video.url}" target="_blank" class="video-btn">
                        <svg class="video-icon" viewBox="0 0 24 24"><path d="M10 15l5.19-3L10 9v6m11.56-7.83c.13.47.22 1.1.28 1.9.07.8.1 1.49.1 2.09L22 12c0 2.19-.16 3.8-.44 4.83-.25.9-.83 1.48-1.73 1.73-.47.13-1.33.22-2.65.28-1.3.07-2.49.1-3.59.1L12 19c-4.19 0-6.8-.16-7.83-.44-.9-.25-1.48-.83-1.73-1.73-.13-.47-.22-1.1-.28-1.9-.07-.8-.1-1.49-.1-2.09L2 12c0-2.19.16-3.8.44-4.83.25-.9.83-1.48 1.73-1.73.47-.13 1.33-.22 2.65-.28 1.3-.07 2.49-.1 3.59-.1L12 5c4.19 0 6.8.16 7.83.44.9.25 1.48.83 1.73 1.73z"/></svg>
                        Ver Clase: ${topic.video.label}
                    </a>
                `;
            }

            card.innerHTML = `
                <span class="badge ${badgeClass}">${topic.area.toUpperCase()}</span>
                <div class="topic-title">${topic.title}</div>
                <span class="topic-book">üìñ ${topic.book}</span>
                <div class="task-list">${tasksHtml}</div>
                ${videoHtml}
            `;
            contentDiv.appendChild(card);
        });

        container.appendChild(details);
    });
    
    updateKPIs();
}

function toggleCheck(id) {
    const el = document.getElementById(id);
    if(el.checked) state.checks[id] = true;
    else delete state.checks[id];
    saveState();
    // No re-render completo para no cerrar acorde√≥n, solo actualizar stats
    // Pero actualizamos el % de la semana visualmente buscando el header
    // Para simplificar, hacemos un render suave o dejamos que el usuario vea el cambio al recargar
    // Opci√≥n mejor: actualizar KPI global
    updateKPIs(); 
}

function updateKPIs() {
    let total = 0;
    let done = 0;
    
    PLAN.forEach(w => w.topics.forEach(t => t.tasks.forEach(tsk => total++)));
    done = Object.keys(state.checks).length;
    
    const pct = total ? Math.round((done/total)*100) : 0;
    
    document.getElementById("kpiDone").textContent = done;
    document.getElementById("kpiLeft").textContent = total - done;
    document.getElementById("headerPercent").textContent = pct + "%";
    document.getElementById("headerFill").style.width = pct + "%";
}

/* ======================== 4. UTILIDADES (Export/Import) ======================== */
function exportData() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
    const a = document.createElement('a');
    a.href = dataStr;
    a.download = "fen_tracker_backup.json";
    a.click();
}

function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = event => {
            try {
                state = JSON.parse(event.target.result);
                saveState();
                render();
                alert("Backup cargado correctamente");
            } catch(err) { alert("Error al leer archivo"); }
        };
        reader.readAsText(file);
    };
    input.click();
}

function resetData() {
    if(confirm("¬øEst√°s seguro de borrar todo? No hay vuelta atr√°s.")) {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
    }
}

// ARRANQUE
init();

</script>
</body>
</html>

